/*
* Author: 
* Description: 
*/
var PageBlockEditor = function(data, parentId) {
  var self = this;
  var blocks = {};
  var version = "0.0.1";
  
  OpenForum.addScript( "/TheLab/Experiments/ContentEditor/text-block-editor.js" )
    .addScript( "/TheLab/Experiments/ContentEditor/pageTitle-block-editor.js" )
    .addScript( "/TheLab/Experiments/ContentEditor/WYSIWYG-block-editor.js" )
    .addScript( "/TheLab/Experiments/ContentEditor/twoColumn-block-editor.js" )
  .go();

  self.initView = function( elementId ) {
    OpenForum.getObject( elementId + "_text" ).setValue( data.title );
    OpenForum.addListener( elementId + "_text", function( obj ) { data.title=obj.getValue(); } );

    var view = "<div class='row panel' id='" + elementId + "_edit" + "'><b>Title:</b> <input of-id='" + elementId + "_text" + "' value='" + data.title + "'/></div>";

    view += "<div style='background-color: white; border: solid 2px white;' id='" + elementId + "_content" + "'>";
    view += renderAddButton( elementId, "add", false);
    for( var i in data.content ) {
      data.content[i].elementId = ("BK" + Math.random() + new Date().getTime()).replaceAll("\\.","_");
      view += "<span id='" + data.content[i].elementId + "'><div style='border: solid 1px; height: 150px;'>Loading...</div></span>";
      view += renderAddButton( data.content[i].elementId, "addAfter", true);
    }
    view += "</div>";

    data.treeNode.setName( renderHighlightLink( elementId + "_content", data.treeNode.getName(), "Page" ) );
    
    data.elementId = elementId;
    data.parentId = parentId;
    OpenForum.setElement( elementId, view );

    initBlocks();
  };
  
  self.initTree = function(treeNode) {
    var node = treeNode.addChild( "Page",{icon: "page"} );
    data.treeNode = node;
    return node;
  };

  self.getElementId = function() {
    return data.elementId;
  };

  self.getParentId = function() {
    return data.parentId;
  };
  
  var getContentIndex = function(id) {
    var index = -1;
    for(var i in data.content) {
      if(data.content[i].elementId == id) {
        index = i;
        break;
      }
    }
    return parseInt( index );
  };
  
  self.addBlock = function(instruction,type) {
    if( instruction.action == "addAfter" ) {
      var index = getContentIndex(instruction.id);

      var template = OpenForum.evaluate( type+"Editor.template" );
      var json = OpenForum.clone(template);

      data.content.splice( index+1,0,json );
    } else {
      var template = OpenForum.evaluate( type+"Editor.template" );
      var json = OpenForum.clone(template);

      data.content.splice( 0,0,json );
    }
    initialisePageEditor( pageData );
  };
  
  self.moveBlockUp = function(id) {
    OpenForum.Table.moveRowUp( data.content, getContentIndex(id) );
    initialisePageEditor( pageData );
  };

  self.moveBlockDown = function(id) {
    OpenForum.Table.moveRowDown( data.content, getContentIndex(id) );
    initialisePageEditor( pageData );
  };
  
  self.removeBlock = function(id) {
    OpenForum.Table.removeRow( data.content, getContentIndex(id) );
    initialisePageEditor( pageData );
  };

  self.setEditMode = function() {
    OpenForum.showElement( data.elementId + "_edit" );
  };

  self.setViewMode = function() {
    OpenForum.showElement( data.elementId + "_edit" );
  };

  var initBlocks = function() {
    for( var i in data.content ) {
      (function(index) {
        OpenForum.waitFor(
          function() {
            return document.getElementById(data.content[index].elementId) != null;
          },
          function() {
            createBlockEditor( data.content[index].block, data.content[index], data.elementId, data.content[index].elementId, data.treeNode );
          },
          500
        );
      } )(i);
    }
  };

  self.render = function() {
    var content = "<!-- Generated by Page Block Editor v " + version + " -->\n<div class='row'>";
    for( var i in data.content ) {
      content += data.content[i].blockEditor.render();
    }
    return content + "\n</div>\n";
  };
};

PageBlockEditor.template = {
    "pageName": "",
    "title": "",
    "block": "page",
    "content": []
};