/*
* Author: 
* Description: 
*
*/

/* Example config
{
  "libraries": ["Thing.sjs"],
  "actions": [
    { "action": "doIt", "parameters": [
      {"name": "name", "type": "string", "required": false},
      {"name": "page", "type": "string", "required": true}
    	], 
     "call": "Thing.doStuff();"
    }
    ]
}
*/
dataTransform.imp("service-definition.json");

try{
  
var json = JSON.parse(input);

var template = OpenForum.loadFile("/OpenForum/FileTemplates/js/get.sjs.default");

var actionTemplate ="if(action===\"&actionName;\") {&parameters;&call;&result;}\n";
var defaultResultTemplate = "\n\tresult = {result: \"ok\", message: \"Performed action \"+action, data: returned};\n";

/*To Do
 * Make service to take library and make service
 * Add logging to queue option
*/
  
var librariesSource = "";
for(var i in json.libraries) {
  librariesSource += "\n\tvar "+json.libraries[i]+" = js.getObject(\""+json.pageName+"\",\""+json.libraries[i]+".sjs\");\n\n"
}
  
var actionSource = "";
for(var i in json.actions) {
  var actionDef = json.actions[i];
  
  var parameterSource = "";
  for(var p in actionDef.parameters) {
    var parameterDef = actionDef.parameters[p];
    parameterSource += "\n\tvar "+parameterDef.name+" = transaction.getParameter(\""+parameterDef.name+"\");\n";
    if(parameterDef.required===true) {
      parameterSource += "\tif("+parameterDef.name+"===null) throw \"Request is missing required parameter "+parameterDef.name+"\";\n";
	  parameterSource += "\t "+parameterDef.name+" = \"\" + "+parameterDef.name+";\n";
    } else {
	  parameterSource += "\t if("+parameterDef.name+"===null) delete "+parameterDef.name+"; else "+parameterDef.name+" = \"\" + "+parameterDef.name+";\n";
    }
  }
  
  var callSource="\tvar returned = "+actionDef.call+"\n";
  
  actionSource += actionTemplate.
    replace("&actionName;",actionDef.action).
    replace("&parameters;",parameterSource).
    replace("&call;","\n"+callSource).
    replace("&result;",defaultResultTemplate);
}

var data = template.substring(0,template.indexOf("/*---8<---")) + librariesSource + actionSource + template.substring(template.indexOf("--->8---*/")+10);
data = "//Autogenerated. Do not edit.\n\n"+data
  
} catch (e) {
  var data = ""+e;
}

output = data;