var canvas;

var locationX = 640000;
var locationY = 315000;

var status;

var MapLayer = function(canvas) {
  
  var blankTile = "/Maps/OSStreetView/blank.png";
  var tileRoot = "/Maps/OSStreetView/NorfolkStreetView";
  var imageWidth = 5000;
  var imageHeight = 5000;
  
  var offsetX = (canvas.width/2)-(imageWidth/2);
  var offsetY = (canvas.height/2)-(imageHeight/2);
  
  var lastMapX = 0;
  var lastMapY = 0;
  
  var tile1 = new Picture(	offsetX-imageWidth,     offsetY-imageHeight,  blankTile);
  var tile2 = new Picture(	offsetX,                         offsetY-imageHeight,  blankTile);
  var tile3 = new Picture(	offsetX+imageWidth,    offsetY-imageHeight,  blankTile);
  
  
  var tile4 = new Picture(	offsetX-imageWidth,     offsetY,                       blankTile);
  var tile5 = new Picture(	offsetX,                         offsetY,                       blankTile);
  var tile6 = new Picture(	offsetX+imageWidth,    offsetY,                       blankTile);
  
  var tile7 = new Picture(	offsetX-imageWidth,     offsetY+imageHeight, blankTile);
  var tile8 = new Picture(	offsetX,                         offsetY+imageHeight, blankTile);
  var tile9 = new Picture(	offsetX+imageWidth,    offsetY+imageHeight, blankTile);
  
  var map = new Composite(0,0);
  map.add(tile1);
  map.add(tile2);
  map.add(tile3);
  map.add(tile4);
  map.add(tile5);
  map.add(tile6);
  map.add(tile7);
  map.add(tile8);
  map.add(tile9);
  
  canvas.add(map);
  canvas.makeDraggable(map);
  canvas.addAnimationListener(this);
  
   var updateTiles = function() {
  
    tile1.img.src = getTile(  locationX-imageWidth,       locationY+imageHeight );
    tile2.img.src = getTile(  locationX,                           locationY+imageHeight );
    tile3.img.src = getTile(  locationX+imageWidth,      locationY+imageHeight );

    tile4.img.src = getTile(  locationX-imageWidth,       locationY );
    tile5.img.src = getTile(  locationX,                           locationY );
     console.log( locationX+" , "+locationY+" = "+getTile(locationX,locationY) );
    tile6.img.src = getTile(  locationX+imageWidth,      locationY );

    tile7.img.src = getTile(  locationX-imageWidth,       locationY-imageHeight );
    tile8.img.src = getTile(  locationX,                           locationY-imageHeight );
    tile9.img.src = getTile(  locationX+imageWidth,      locationY-imageHeight );
  };
  
  var getTile = function(x,y) {
    var tileFile = OSMap.getTile(x,y);
    if( OpenForum.file.attachmentExists(tileRoot,tileFile)==="true" ) {
      return tileRoot+"/"+tileFile;
    } else {
      return blankTile;
    }
  };
  
  updateTiles();
  console.log( "Tile 5:" + tile5.img.src );
  
  this.getDebug = function() {
    return (tile5.img.src).substring(tile5.img.src.lastIndexOf("/"));
  };
  
  this.updateLocation = function() {
    var sx=locationX%10000;
    //sx = (sx - 5000) % 5000;
    var sy=locationY%10000;
    //sy = sy % 5000;
    map.x = sx;
    map.y = sy;
    lastMapX = map.x;
    lastMapY = map.y;
    updateTiles();
  };
  
  this.processFrame = function(frame) {

      var dx = 0;
      var dy = 0;

      if(map.x!==lastMapX) {
        dx = map.x-lastMapX;
        locationX -= dx;
        lastMapX = map.x;
      }
      if(map.y!==lastMapY) {
        dy = map.y-lastMapY;

        locationY += dy;
        lastMapY = map.y;
      }

      var needsUpdate = false;
      if(map.x<-imageWidth || map.x>imageWidth) {
        map.x = map.x%imageWidth;
        lastMapX = map.x;
        needsUpdate=true;
      }

      if(map.y<-imageHeight || map.y>imageHeight) {
        map.y = map.y%imageHeight;
        map.y = 0;
        lastMapY = 0;
        needsUpdate=true;
      }

      if( needsUpdate ) {
        updateTiles();
      }
  };
  
  this.zoomIn = function() {
    map.scaleX+=0.1;
    map.scaleY+=0.1;
  };
  
  this.zoomOut = function() {
    map.scaleX-=0.1;
    map.scaleY-=0.1;
  };
};

function initMap() {
  canvas =new Canvas("mapCanvas");
  Giraffe.Interactive.setInteractive(canvas);
  canvas.add( new Rectangle(0,0,screenWidth,screenHeight).setFillColor("#003300") );
  Giraffe.setAnimated(canvas);
  mapLayer = new MapLayer(canvas);
  
  canvas.startAnimation(20,100,true);
  
  zoomIn = new Circle(10,100,10);
  zoomIn.onClick = function(x,y) {
    mapLayer.zoomIn();
  };
  
  zoomOut = new Circle(10,130,15);
  zoomOut.onClick = function(x,y) {
    mapLayer.zoomOut();
  };
  
  canvas.add(zoomIn);
  canvas.add(zoomOut);
  
  canvas.add( new Rectangle(5,5,800,35).setFillColor("white").setColor("black") );
  state = new Text(30,30,"Status: ",25,"Arial").setFillColor("#0000cc");
  state.animate = function(frame) {
    state.text = "X:"+locationX+" Y:"+locationY+" Tile:" + mapLayer.getDebug();
  };
  
  canvas.add( state );
}

function go() {
    /*var ll2w = new LatLng(lat,lng);
    ll2w.WGS84ToOSGB36();
    var os2w = ll2w.toOSRef();
    locationX = Math.ceil(os2w.easting)-2500;
    locationY = Math.ceil(os2w.northing)-2500;*/
  
  var wgs84 = LatLonE(lat, lng, LatLonE.datum.WGS84);
  var osgb = wgs84.convertDatum(LatLonE.datum.OSGB36);
  var gridref = OsGridRef.latLonToOsGrid(osgb);
  
    locationX = Math.ceil(gridref.easting);//+(canvas.width/2);
    locationY = Math.ceil(gridref.northing);//+(canvas.height/2);
  
  mapLayer.updateLocation();
}

function go2() {
    /*var ll2w = new LatLng(lat,lng);
    ll2w.WGS84ToOSGB36();
    var os2w = ll2w.toOSRef();
    locationX = Math.ceil(os2w.easting)-2500;
    locationY = Math.ceil(os2w.northing)-2500;*/
  
  var wgs84 = LatLonE(lat2, lng2, LatLonE.datum.WGS84);
  var osgb = wgs84.convertDatum(LatLonE.datum.OSGB36);
  var gridref = OsGridRef.latLonToOsGrid(osgb);
  
    locationX = Math.ceil(gridref.easting);//+(canvas.width/2);
    locationY = Math.ceil(gridref.northing);//+(canvas.height/2);
  
  mapLayer.updateLocation();
}


function go3() {
  
    locationX = Math.ceil(east);
    locationY = Math.ceil(north);
  
  mapLayer.updateLocation();
}


