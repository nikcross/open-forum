var action = transaction.getParameter("action");
if( action==null ) {
	transaction.setResult(transaction.SHOW_PAGE);
  return;
}

  action = ""+action; // Cast to String
  result = "";
  
  if(action === "getTimes") {
    var suncalc = js.loadObject("/GeoLocation","suncalc.js");
    var timeToJson = function(date) {
      return {hour: date.getHours(), minute: date.getMinutes()};
    };
    
    var dateToJson = function(date) {
      return {year: date.getFullYear(),month: date.getMonth()+1, day: date.getDate()};
    };
    
    var time = ""+transaction.getParameter("time");
    if(time==="today") {
      time = new Date();
    } else {
    	time = new Date().setTime( parseInt(time,10) );
    }
    var latitude = parseFloat(""+transaction.getParameter("latitude"));
    var longitude = parseFloat(""+transaction.getParameter("longitude"));
    
    var times = suncalc.getSunCalc().getTimes(time, latitude, longitude);
    time.latitude = latitude;
    time.longitude = longitude;
    time.time = dateToJson(time);
    time.action = action;
    time.sunrise = timeToJson(times.sunrise);
    //var times = {action: action, type: typeof(suncalc)};
    result = JSON.stringify(time);
    
  } else {
  	result = "action not recognised";
  }

  transaction.sendPage( result );
